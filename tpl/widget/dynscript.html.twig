{{ script({ dynamic: __oxid_include_dynamic }) }}

<script>{% apply spaceless %}
    var sBaseUrl = '{{ oViewConf.getSelfActionLink()|raw }}';
    var sActCl = '{{ oViewConf.getTopActiveClassName() }}';
{% endapply %}</script>

{# Google Analytics Page Tracking #}
{% set sGATrackingId = oViewConf.getViewThemeParam('sGATrackingId') %}
{% if oViewConf.getViewThemeParam('blUseGAPageTracker') and sGATrackingId %}
    <script async src="https://www.googletagmanager.com/gtag/js?id={{ sGATrackingId }}"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', '{{ sGATrackingId }}', {
            'debug_mode':true,
            {% if oViewConf.getViewThemeParam('blGAAnonymizeIPs') %}
            'anonymize_ip': true
            {% endif %}
        });
    </script>
{% endif %}

{# Google Analytics eCommerce Tracking #}
{% if oViewConf.getViewThemeParam('blUseGAEcommerceTracking') and sGATrackingId and oViewConf.getTopActiveClassName() == 'thankyou' %}
    {% set oOrder = oView.getOrder() %}

    {% if oOrder %}
        <script>
            gtag('event', 'purchase', {
                "transaction_id": "{{ oOrder.oxorder__oxordernr.value }}",            // Transaction ID. Required.
                "affiliation": "{{ oxcmp_shop.oxshops__oxname.value }}",              // Affiliation or store name.
                "value": {{ oOrder.oxorder__oxtotalordersum.value }},                // Grand Total.
                "currency": "{{ oOrder.oxorder__oxcurrency.value }}",                 // Local currency code.
                "tax": {{ oOrder.oxorder__oxartvatprice1.value+oOrder.oxorder__oxartvatprice2.value }}, // Tax.
                "shipping": {{ oOrder.oxorder__oxdelcost.value }},                   // Shipping.
                "items": [
                    {% for oOrderArticle in oOrder.getOrderArticles() %}
                    {
                        "item_name": "{{ oOrderArticle.oxorderarticles__oxtitle.value|trim }}",  // Product name. Required.
                        "item_id": "{{ oOrderArticle.oxorderarticles__oxartnum.value }}",       // SKU/code.
                        "price": {{ oOrderArticle.getPrice().getBruttoPrice() }},              // Unit price.
                        "quantity": {{ oOrderArticle.oxorderarticles__oxamount.value }},       // Quantity.
                        "item_category": "{% set oMainCategory = oOrderArticle.getArticle().getCategory() %}{% if oMainCategory %}{{ oMainCategory.oxcategories__oxtitle.value }}{% endif %}" // Category or variation.
                    }{% if not loop.last %},{% endif %}
                    {% endfor %}
                ]
            });
        </script>
    {% endif %}
{% endif %}

{# Google zertifizierte HÃ¤ndler #}
{% if oViewConf.getViewThemeParam('blUseGoogleTS') %}
    {% set sGoogleVendorId = oViewConf.getViewThemeParam('sGoogleVendorId') %}
    {% set sGoogleShoppingAccountId = oViewConf.getViewThemeParam('sGoogleShoppingAccountId') %}
    {% set sPageLanguage = oViewConf.getViewThemeParam('sPageLanguage') %}
    {% set sShoppingCountry = oViewConf.getViewThemeParam('sShoppingCountry') %}
    {% set sShoppingLanguage = oViewConf.getViewThemeParam('sShoppingLanguage') %}

    {% if oViewConf.getTopActiveClassName() == 'details' %}
        {% set oArticle = oView.getProduct() %}
        {% set sGoogleShoppingProductId = oArticle.oxarticles__oxartnum.value %}
    {% endif %}

    {% if sGoogleVendorId and sShoppingLanguage %}
        <!-- begin google customer rating badge -->
        <script src="https://apis.google.com/js/platform.js?onload=renderBadge"
                async defer>
        </script>

        <script>
            window.renderBadge = function() {
                var ratingBadgeContainer = document.createElement("div");
                document.body.appendChild(ratingBadgeContainer);
                window.gapi.load('ratingbadge', function() {
                    window.gapi.ratingbadge.render(
                        ratingBadgeContainer, {
                            "merchant_id": "{{ sGoogleVendorId }}",
                            "position": "BOTTOM_RIGHT",
                            "locale": "{{ sShoppingLanguage|default('de') }}"
                        });
                });
            }
        </script>

        {% if sShoppingLanguage %}
            <script>
                window.___gcfg = {
                    lang: "{{ sShoppingLanguage|default('de') }}"
                };
            </script>
        {% endif %}
        <!-- end google customer rating badge -->

        {# Order confirmation module #}
        {% if oViewConf.getTopActiveClassName() == 'thankyou' %}
            {% set sShippingDaysOnStock = oViewConf.getViewThemeParam('sShippingDaysOnStock') %}
            {% set sShippingDaysNotOnStock = oViewConf.getViewThemeParam('sShippingDaysNotOnStock') %}
            {% set sDeliveryDaysOnStock = oViewConf.getViewThemeParam('sDeliveryDaysOnStock') %}
            {% set sDeliveryDaysNotOnStock = oViewConf.getViewThemeParam('sDeliveryDaysNotOnStock') %}

            {% if sShippingDaysOnStock and sShippingDaysNotOnStock and sDeliveryDaysOnStock and sDeliveryDaysNotOnStock %}
                {% if not oOrder %}
                    {% set oOrder = oView.getOrder() %}
                {% endif %}

                {% set blHasPreOrder = false %}
                {% set oCountry = "oxCountry"|oxNew %}
                {% if oCountry.load(oOrder.oxorder__oxbillcountryid.value) %}
                    {% set sCustomerCountry = oCountry.oxcountry__oxisoalpha2.value %}
                {% endif %}

                    {# calculate estimated delivery date #}
                    {% if blHasPreOrder %}
                        {% set sDeliveryDate = (sDeliveryDaysNotOnStock ~ "weekdays")|strtotime %}
                    {% else %}
                        {% set sDeliveryDate = (sDeliveryDaysOnStock ~ "weekdays")|strtotime %}
                    {% endif %}

                    <script src="https://apis.google.com/js/platform.js?onload=renderOptIn" async defer></script>
                    <script>
                        function renderOptIn() {
                            window.gapi.load('surveyoptin', function() {
                                window.gapi.surveyoptin.render({
                                    "merchant_id": "{{ sGoogleVendorId }}",
                                    "order_id": "{{ oOrder.oxorder__oxordernr.value }}",
                                    "email": "{{ oOrder.oxorder__oxbillemail.value }}",
                                    "delivery_country": "{{ sCustomerCountry }}",
                                    "estimated_delivery_date": "{{ sDeliveryDate|date('Y-m-d') }}",
                                    "opt_in_style": "CENTER_DIALOG"
                                });
                            });
                        }
                    </script>

                    {% if twig.capture.sGtsItems %}
                        {{ twig.capture.sGtsItems }}
                    {% endif %}
         {% endif %}
        {% endif %}
    {% endif %}
{% endif %}
